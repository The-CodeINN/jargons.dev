---
/**
 * @todo Get URL of previous page (maybe from `referer`) and return there on Navigation back; good for browse page
 */
import BaseLayout from "./base.astro";
import { getCollection } from "astro:content";
import Navbar from "../components/navbar.astro";
import Search from "../components/islands/search.jsx";

const { frontmatter } = Astro.props;
const dictionary = await getCollection("dictionary");

/**
 * @todo implement a better way to resolve the `slug` used in the `editUrl`
 * `frontmatter.url.split("/")*****` will not scale when we bring in internationalization
 */
const editUrl = `/editor/edit/${frontmatter.url.split("/")[3].split(".")[0]}`;
---

<BaseLayout pageTitle={ frontmatter.title }>
  <Navbar>
    <Search triggerSize="sm" dictionary={dictionary} client:load />
  </Navbar>

	<main class="max-w-screen-lg p-5 md:mt-10 mx-auto min-h-screen space-y-6">
    <div class="w-full">
      <h1 class="text-3xl md:text-7xl font-black" id="whirl-word-title">
        { frontmatter.title }
      </h1>
      <!-- Metatab -->
      <div class="flex mt-6 justify-between" id="whirl-word-metatab">
        <!-- WIP Meta Features -->
        <!-- <div class="grow flex items-center space-x-2">
          <div class="w-10 h-10 bg-neutral-100 rounded-full" />
          <div class="w-2/5 h-3 bg-neutral-100 rounded-lg" />
        </div> -->
        
        <!-- Edit Button -->
        <a href={editUrl}
          class="flex items-center space-x-0.5 text-xs"
          id="whirl-word-edit"
        >
          <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M11.32 6.176H5c-1.105 0-2 .949-2 2.118v10.588C3 20.052 3.895 21 5 21h11c1.105 0 2-.948 2-2.118v-7.75l-3.914 4.144A2.46 2.46 0 0 1 12.81 16l-2.681.568c-1.75.37-3.292-1.263-2.942-3.115l.536-2.839c.097-.512.335-.983.684-1.352l2.914-3.086Z" clip-rule="evenodd"/>
            <path fill-rule="evenodd" d="M19.846 4.318a2.148 2.148 0 0 0-.437-.692 2.014 2.014 0 0 0-.654-.463 1.92 1.92 0 0 0-1.544 0 2.014 2.014 0 0 0-.654.463l-.546.578 2.852 3.02.546-.579a2.14 2.14 0 0 0 .437-.692 2.244 2.244 0 0 0 0-1.635ZM17.45 8.721 14.597 5.7 9.82 10.76a.54.54 0 0 0-.137.27l-.536 2.84c-.07.37.239.696.588.622l2.682-.567a.492.492 0 0 0 .255-.145l4.778-5.06Z" clip-rule="evenodd"/>
          </svg>
          <span>
            Suggest Improvement
          </span>          
        </a>
      </div>
    </div>

    <!-- Meaning -->
    <article class="w-full max-w-screen-lg prose" id="whirl-word-content">
      <slot /> 
    </article>

    <!-- Scripts 
    TODO [THOUGHTS]: I didn't want to implement anything using the `script` tag at all, but this looked to be..
    ..the only means of adding current word to recent searches when word is opened on client-side, will be..
    ..nice if we can find another means ;)
    -->
    <script>
      import { $addToRecentSearchesFn } from "../lib/stores/search.js";
      $addToRecentSearchesFn({
        word: document.querySelector("h1").textContent.trim(),
        url: document.location.href
      });

      import { driver } from "driver.js";
		  import "driver.js/dist/driver.css";

      function run() {
        let oldMetaValue;
        const metatab = document.querySelector("#whirl-word-metatab");

        const driverObj = driver({
          showProgress: true,
          steps: [
            {
              popover: {
                title: "Word Added to Recent Searches",
                description: "Now that you are here, this word as now been added to your recent searches, so it will be displayed on the <a href='../'>homepage</a>."
              }
            },
            {
              element: "#whirl-word-title",
              popover: {
                title: "Word Title",
                description: "Ummm, here's the word title, I don't how to better describe that ðŸ¤”"
              }
            },
            {
              element: "#whirl-word-content",
              popover: {
                title: "Word Content",
                description: "..and Here's the content i.e. the Definition/Meaning to the word; this content is pulled from a markdown file and can hold text content even to code examples if needed.",
                onNextClick: () => {
                  oldMetaValue = metatab.innerHTML;
                  metatab.innerHTML = `
                    <div class="grow flex items-center space-x-2 mr-3" id="whirl-metatab-future">
                      <div class="w-10 h-10 bg-neutral-300 rounded-full"></div> 
                      <div class="w-1/5 h-3 bg-neutral-300 rounded-lg"></div> 
                      <div class="w-2/5 h-3 bg-neutral-300 rounded-lg"></div> 
                      <div class="w-1/5 h-3 bg-neutral-300 rounded-lg"></div> 
                      <div class="w-1/5 h-3 bg-neutral-300 rounded-lg"></div> 
                    </div> 
                    <a href="/editor/edit/tuple" class="flex items-center space-x-0.5 text-xs" id="whirl-word-edit"> 
                      <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"> 
                        <path fill-rule="evenodd" d="M11.32 6.176H5c-1.105 0-2 .949-2 2.118v10.588C3 20.052 3.895 21 5 21h11c1.105 0 2-.948 2-2.118v-7.75l-3.914 4.144A2.46 2.46 0 0 1 12.81 16l-2.681.568c-1.75.37-3.292-1.263-2.942-3.115l.536-2.839c.097-.512.335-.983.684-1.352l2.914-3.086Z" clip-rule="evenodd"></path> 
                        <path fill-rule="evenodd" d="M19.846 4.318a2.148 2.148 0 0 0-.437-.692 2.014 2.014 0 0 0-.654-.463 1.92 1.92 0 0 0-1.544 0 2.014 2.014 0 0 0-.654.463l-.546.578 2.852 3.02.546-.579a2.14 2.14 0 0 0 .437-.692 2.244 2.244 0 0 0 0-1.635ZM17.45 8.721 14.597 5.7 9.82 10.76a.54.54 0 0 0-.137.27l-.536 2.84c-.07.37.239.696.588.622l2.682-.567a.492.492 0 0 0 .255-.145l4.778-5.06Z" clip-rule="evenodd"></path>
                      </svg> 
                      <span>Suggest Improvement</span> 
                    </a>
                  `;
                  driverObj.moveNext();
                }
              }
            },
            {
              element: "#whirl-word-metatab",
              popover: {
                title: "Word MetaTab",
                description: "Here's the tab that carries some actions a user can perform within the context of the current word; <b>it an entry point to the integrations and functionality jargons.dev offers now and coming iterations.</b>",
                onPrevClick: () => {
                  metatab.innerHTML = oldMetaValue;
                  driverObj.movePrevious();
                }
              }
            },
            {
              element: "#whirl-metatab-future",
              popover: {
                title: "Some Future Integrations",
                description: `
                  <ul>
                    <li><b>ðŸ”Š A Page Reader</b> - for reading definitions out in a smart way</li>
                    <li><b>ðŸ¤– AI Integration</b> - coming soon is "<b>âœ¨jAI</b>", an AI assistant trained on the dictionary words, available to explain words further and ask follow-up questions to ðŸ˜‰</li>
                  </ul>
                `,
                onNextClick: () => {
                  metatab.innerHTML = oldMetaValue;
                  driverObj.moveNext();
                }
              }
            },
            {
              element: "#whirl-word-edit",
              popover: {
                title: "Suggest Word Edit",
                description: "Here's one of our current functionalities; this is the ability to suggest edits to the current word and done through the <b>'Jargons Editor'</b>",
                onPrevClick: () => {
                  oldMetaValue = metatab.innerHTML;
                  metatab.innerHTML = `
                    <div class="grow flex items-center space-x-2 mr-3" id="whirl-metatab-future">
                      <div class="w-10 h-10 bg-neutral-300 rounded-full"></div> 
                      <div class="w-1/5 h-3 bg-neutral-300 rounded-lg"></div> 
                      <div class="w-2/5 h-3 bg-neutral-300 rounded-lg"></div> 
                      <div class="w-1/5 h-3 bg-neutral-300 rounded-lg"></div> 
                      <div class="w-1/5 h-3 bg-neutral-300 rounded-lg"></div> 
                    </div> 
                    <a href="/editor/edit/tuple" class="flex items-center space-x-0.5 text-xs" id="whirl-word-edit"> 
                      <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"> 
                        <path fill-rule="evenodd" d="M11.32 6.176H5c-1.105 0-2 .949-2 2.118v10.588C3 20.052 3.895 21 5 21h11c1.105 0 2-.948 2-2.118v-7.75l-3.914 4.144A2.46 2.46 0 0 1 12.81 16l-2.681.568c-1.75.37-3.292-1.263-2.942-3.115l.536-2.839c.097-.512.335-.983.684-1.352l2.914-3.086Z" clip-rule="evenodd"></path> 
                        <path fill-rule="evenodd" d="M19.846 4.318a2.148 2.148 0 0 0-.437-.692 2.014 2.014 0 0 0-.654-.463 1.92 1.92 0 0 0-1.544 0 2.014 2.014 0 0 0-.654.463l-.546.578 2.852 3.02.546-.579a2.14 2.14 0 0 0 .437-.692 2.244 2.244 0 0 0 0-1.635ZM17.45 8.721 14.597 5.7 9.82 10.76a.54.54 0 0 0-.137.27l-.536 2.84c-.07.37.239.696.588.622l2.682-.567a.492.492 0 0 0 .255-.145l4.778-5.06Z" clip-rule="evenodd"></path>
                      </svg> 
                      <span>Suggest Improvement</span> 
                    </a>
                  `;
                  driverObj.movePrevious();
                }
              },
            },
            {
              element: "#whirl-word-edit",
              popover: {
                title: "Let's Suggest an Edit",
                description: "Whenever, you're ready! let's suggest an edits to this word; Click this link to go to the <b>'Jargons Editor'</b>",
                onNextClick: () => {
                  metatab.innerHTML = oldMetaValue;
                  driverObj.moveNext();
                }
              }
            }
          ]
        });
        driverObj.drive();
      }
      run();
      document.querySelector("#whirl-btn").addEventListener("click", run);
    </script>
  </main>
</BaseLayout>